"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),fetch=require("node-fetch"),$=require("cheerio"),_require=require("./Builders"),HTMLBuilder=_require.HTMLBuilder,JSONBuilder=_require.JSONBuilder,_require2=require("./Loggers"),Logger=_require2.Logger,LoggerVerbosity=_require2.LoggerVerbosity,defaultify=require("./defaultify"),logger=new Logger,Blizzcle=function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};(0,_classCallCheck2["default"])(this,a),this.verbose=defaultify(b.verbose,!1),this.count=defaultify(b.count,1),this.detail=defaultify(b.detail,!1),this.filename=defaultify(b.filename,void 0),this.filetype=defaultify(b.filetype,void 0),this.game=defaultify(b.game.toLowerCase(),"heroes-of-the-storm"),this.language=defaultify(b.language.toLowerCase(),"en-us"),this.rawdata=defaultify(b.rawdata,!1),this.color=defaultify(b.color,!0),logger.set(console.log,this.color,this.verbose?LoggerVerbosity.verbose:LoggerVerbosity.minimal),logger.debug("Settings: ".concat(JSON.stringify({verbose:this.verbose,count:this.count,detail:this.detail,filename:this.filename,filetype:this.filetype,game:this.game,language:this.language,rawdata:this.rawdata,color:this.color})))}return(0,_createClass2["default"])(a,[{key:"get",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var b=this;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this._getPages().then(function(a){a.forEach(function(a){var c;(c=b.pages).push.apply(c,(0,_toConsumableArray2["default"])(b._parse(a.html)))})})["catch"](function(a){throw a});case 2:if(this.pages.sort(function(a,b){return b.id-a.id}),this.pages=0===this.count?this.pages:this.pages.slice(0,this.count),!(this.detail||void 0!==this.filename)){a.next=7;break}return a.next=7,this._detailtify()["catch"](function(a){throw a});case 7:return a.abrupt("return",this.pages);case 8:case"end":return a.stop();}},a,this)}));return function get(){return a.apply(this,arguments)}}()},{key:"save",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var b,c,d;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if("undefined"!=typeof this.filename){a.next=3;break}throw logger.error("filename is not defined"),new Error("filename is not defined");case 3:return"undefined"==typeof this.filetype&&(/\.(json|html?)$/i.test(this.filename)?(this.filetype=this.filename.match(/\.(json|html?)$/i)[1].toLowerCase(),logger.debug("File type detected as \"".concat(this.filetype,"\""))):(this.filetype="json",logger.warn("File type not detected, fallback to json."))),a.next=6,this.get()["catch"](function(a){throw a});case 6:if(b=a.sent,b=b.sort(function(c,a){return c.id-a.id}),"json"!==this.filetype.toLowerCase()){a.next=12;break}return c=new JSONBuilder(b,this.game,this.filename),c.build(),a.abrupt("return",c.save());case 12:if("html"!==this.filetype.toLowerCase()){a.next=16;break}return d=new HTMLBuilder(b,this.game,this.filename),d.build(),a.abrupt("return",d.save());case 16:throw logger.error("Unable to save file"),new Error("Unable to save file");case 18:case"end":return a.stop();}},a,this)}));return function save(){return a.apply(this,arguments)}}()},{key:"_download",value:function _download(a,b){var c="";Object.entries(b).forEach(function(a){""!==c&&(c+="&"),c+="".concat(a[0],"=").concat(a[1])});var d="".concat("https://news.blizzard.com","/").concat(this.language,"/blog/").concat(a,"?").concat(c,"&__NO_CACHE__=").concat(+new Date);return fetch(d).then(function(a){if(!a.ok)throw Error(a.statusText);return a.json()})["catch"](function(a){throw Error(a)})}},{key:"_getPages",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var b,c,d,e,f,g;return _regenerator["default"].wrap(function(a){var h=Math.ceil;for(;;)switch(a.prev=a.next){case 0:return this.pages=[],c=[],logger.debug("Downloading Page 1 for metadata and its content."),a.next=5,this._download("list",{pageNum:1,community:this.game})["catch"](function(a){throw a});case 5:for(d=a.sent,(b=this.pages).push.apply(b,(0,_toConsumableArray2["default"])(this._parse(d.html))),this.metadata={totalCount:d.totalCount,game:"undefined"==typeof d.community?"All":d.community.slug},e=this.metadata.totalCount,logger.debug("Community name : ".concat(this.metadata.game)),logger.debug("Total article count in \"".concat(this.metadata.game,"\": ").concat(this.metadata.totalCount)),0!==this.count&&(e=this.count,logger.debug("Number of articles will be extracted: ".concat(e))),f=h((e-30)/30),logger.debug("Number of extra pages to be fetched: ".concat(f)),g=0;g<f;g++)logger.debug("Fetching extra page: ".concat(g+1," / ").concat(f," ...")),c.push(this._download("list",{pageNum:g+2,community:this.game}));return logger.debug("Waiting ".concat(c.length," requests to be completed...")),a.abrupt("return",Promise.all(c));case 17:case"end":return a.stop();}},a,this)}));return function _getPages(){return a.apply(this,arguments)}}()},{key:"_parse",value:function _parse(a){var b=[];return $(".GalleryItem",a).each(function(){var a=$(this).find("div.TextOverflow").text().trim(),c="https:".concat($(this).find("div.Card-image").css("background-image").replace("url(","").replace(")","").replace(/"/gi,"")),d=$(this).find("a.ArticleLink").attr("href"),e=$(this).find("span.ArticleListItem-footerTimestamp").text().trim(),f=parseInt($(this).find("a.ArticleLink").attr("data-article-id"),10);b.push({title:a,thumbnail:c,description:null,link:/^https?:\/\//i.test(d)?d:"https://news.blizzard.com".concat(d),timestamp:e,commentCount:0||0,id:f})}),$(".ArticleListItem",a).each(function(){var a=$(this).find("h3.ArticleListItem-title").text().trim(),c="https:".concat($(this).find("div.ArticleListItem-image").css("background-image").replace("url(","").replace(")","").replace(/"/gi,"")),d=$(this).find(".ArticleListItem-description").text().trim(),e=$(this).find("a.ArticleLink").attr("href"),f=$(this).find("span.ArticleListItem-footerTimestamp").text().trim(),g=parseInt($(this).find(".ArticleCommentCount-count").text().trim(),10),h=parseInt($(this).find("a.ArticleLink").attr("data-article-id"),10);b.push({title:a,thumbnail:c,description:d,link:/^https?:\/\//i.test(e)?e:"https://news.blizzard.com".concat(e),timestamp:f,commentCount:g||0,id:h})}),b}},{key:"_detailtify",value:function(){var a=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function a(){var b,c,d,e,f,g,h,j,k;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:for(logger.debug("Downloading details to each post"),b=[],c=0;c<this.pages.length;c++)d=this.pages[c],logger.debug("Fetching Details of the post ".concat(d.id," (").concat(d.title,")")),b.push(this._download("detail",{blogId:d.id,full:!1}));return logger.debug("Waiting ".concat(b.length," request to be completed...")),a.next=6,Promise.all(b)["catch"](function(a){throw a});case 6:for(e=a.sent,f=0;f<e.length;f++)g=e[f],h=$("article",g.html).find(".ArticleDetail-bylineDate").attr("title"),j=$("article",g.html).find(".ArticleDetail-content"),k=+new Date(h),this.pages[f].timestamp=k,this.pages[f].bodyHTML=j.html().trim(),this.pages[f].body=j.text().trim(),this.rawdata&&(this.pages[f]._rawData=e);case 8:case"end":return a.stop();}},a,this)}));return function _detailtify(){return a.apply(this,arguments)}}()}]),a}();module.exports=Blizzcle;