"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),fetch=require("node-fetch"),$=require("cheerio"),_require=require("./Builders"),HTMLBuilder=_require.HTMLBuilder,_require2=require("./Builders"),JSONBuilder=_require2.JSONBuilder,Blizzcle=/*#__PURE__*/function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};(0,_classCallCheck2["default"])(this,a),this.verbose="undefined"!=typeof b.verbose&&b.verbose,this.count="undefined"==typeof b.count?0:parseInt(b.count,10),this.detail="undefined"!=typeof b.detail&&b.detail,this.filename="undefined"==typeof b.filename?void 0:b.filename,this.filetype="undefined"==typeof b.filetype?void 0:b.filetype,this.game="undefined"==typeof b.game?"heroes-of-the-storm":b.game.toLowerCase(),this.language="undefined"==typeof b.language?"en-us":b.language.toLowerCase(),this.rawdata="undefined"!=typeof b.rawdata&&b.rawdata,this._log(JSON.stringify({verbose:this.verbose,count:this.count,detail:this.detail,filename:this.filename,filetype:this.filetype,game:this.game,language:this.language,rawdata:this.rawdata}))}return(0,_createClass2["default"])(a,[{key:"get",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(){var b=this;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this._getPages().then(function(a){a.forEach(function(a){var c;(c=b.pages).push.apply(c,(0,_toConsumableArray2["default"])(b._parse(a.html)))})})["catch"](function(a){throw a});case 2:if(this.pages=0===this.count?this.pages:this.pages.slice(0,this.count),!(this.detail||void 0!==this.filename)){a.next=6;break}return a.next=6,this._detailtify()["catch"](function(a){throw a});case 6:return a.abrupt("return",this.pages);case 7:case"end":return a.stop();}},a,this)}));return function get(){return a.apply(this,arguments)}}()},{key:"save",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(){var b,c,d,e,f=arguments;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b=0<f.length&&void 0!==f[0]?f[0]:{},"undefined"!=typeof this.filename){a.next=3;break}throw new Error("filename is not defined");case 3:return"undefined"==typeof this.filetype&&(/\.(json|html?)$/i.test(b.filename)?(this.filetype=this.filename.match(/\.(json|html?)$/i)[1].toLowerCase(),this._log("File type detected as ".concat(this.type))):(this.filetype="json",this._log("File type not detected, fallback to json."))),a.next=6,this.get()["catch"](function(a){throw a});case 6:if(c=a.sent,c=c.sort(function(c,a){return c.id-a.id}),"json"!==this.filetype.toLowerCase()){a.next=12;break}return d=new JSONBuilder(c,this.game,this.filename),d.build(),a.abrupt("return",d.save());case 12:if("html"!==this.filetype.toLowerCase()){a.next=16;break}return e=new HTMLBuilder(c,this.game,this.filename),e.build(),a.abrupt("return",e.save());case 16:throw console.log(this.filetype),new Error("Unable to save file");case 18:case"end":return a.stop();}},a,this)}));return function save(){return a.apply(this,arguments)}}()},{key:"_download",value:function _download(a,b){var c="";Object.entries(b).forEach(function(a){""!==c&&(c+="&"),c+="".concat(a[0],"=").concat(a[1])});var d="".concat("https://news.blizzard.com","/").concat(this.language,"/blog/").concat(a,"?").concat(c,"&__NO_CACHE__=").concat(+new Date);return this._log(d),fetch(d).then(function(a){if(!a.ok)throw Error(a.statusText);return a.json()})["catch"](function(a){throw Error(a)})}},{key:"_getPages",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(){var b,c,d,e,f,g;return _regenerator["default"].wrap(function(a){var h=Math.ceil;for(;;)switch(a.prev=a.next){case 0:return this.pages=[],c=[],this._log("Downloading Page 1 for metadata and its content."),a.next=5,this._download("list",{pageNum:1,community:this.game})["catch"](function(a){throw a});case 5:for(d=a.sent,(b=this.pages).push.apply(b,(0,_toConsumableArray2["default"])(this._parse(d.html))),this.metadata={totalCount:d.totalCount,game:"undefined"==typeof d.community?"All":d.community.slug},e=this.metadata.totalCount,this._log("Community name : ".concat(this.metadata.game)),this._log("Total article count in \"".concat(this.metadata.game,"\": ").concat(this.metadata.totalCount)),0!==this.count&&(e=this.count,this._log("Number of articles will be extracted: ".concat(e))),f=h((e-30)/30),this._log("Number of extra pages to be fetched: ".concat(f)),g=0;g<f;g++)this._log("Fetching extra page: ".concat(g+1," / ").concat(f," ...")),c.push(this._download("list",{pageNum:g+2,community:this.game}));return this._log("Waiting ".concat(c.length," request to be completed...")),a.abrupt("return",Promise.all(c));case 17:case"end":return a.stop();}},a,this)}));return function _getPages(){return a.apply(this,arguments)}}()// eslint-disable-next-line class-methods-use-this
},{key:"_parse",value:function _parse(a){var b=[];// Blogs in feature
return $(".GalleryItem",a).each(function(){var a=$(this).find("div.TextOverflow").text().trim(),c="https:".concat($(this).find("div.Card-image").css("background-image").replace("url(","").replace(")","").replace(/"/gi,"")),d=$(this).find("a.ArticleLink").attr("href"),e=$(this).find("span.ArticleListItem-footerTimestamp").text().trim(),f=parseInt($(this).find("a.ArticleLink").attr("data-article-id"),10);b.push({title:a,thumbnail:c,description:null,link:/^https?:\/\//i.test(d)?d:"https://news.blizzard.com".concat(d),timestamp:e,commentCount:0||0,id:f})}),$(".ArticleListItem",a).each(function(){var a=$(this).find("h3.ArticleListItem-title").text().trim(),c="https:".concat($(this).find("div.ArticleListItem-image").css("background-image").replace("url(","").replace(")","").replace(/"/gi,"")),d=$(this).find(".ArticleListItem-description").text().trim(),e=$(this).find("a.ArticleLink").attr("href"),f=$(this).find("span.ArticleListItem-footerTimestamp").text().trim(),g=parseInt($(this).find(".ArticleCommentCount-count").text().trim(),10),h=parseInt($(this).find("a.ArticleLink").attr("data-article-id"),10);b.push({title:a,thumbnail:c,description:d,link:/^https?:\/\//i.test(e)?e:"https://news.blizzard.com".concat(e),timestamp:f,commentCount:g||0,id:h})}),b}},{key:"_detailtify",value:function(){var a=(0,_asyncToGenerator2["default"])(/*#__PURE__*/_regenerator["default"].mark(function a(){var b,c,d,e,f,g,h,j,k;return _regenerator["default"].wrap(function(a){for(;;)switch(a.prev=a.next){case 0:for(this._log("Downloading details to each post"),b=[],c=0;c<this.pages.length;c++)d=this.pages[c],this._log("Fetching Details of the post ".concat(d.id," (").concat(d.title,")")),b.push(this._download("detail",{blogId:d.id,full:!1}));return this._log("Waiting ".concat(b.length," request to be completed...")),a.next=6,Promise.all(b)["catch"](function(a){throw a});case 6:for(e=a.sent,f=0;f<e.length;f++)g=e[f],h=$("article",g.html).find(".ArticleDetail-bylineDate").attr("title"),j=$("article",g.html).find(".ArticleDetail-content"),k=+new Date(h),this.pages[f].timestamp=k,this.pages[f].bodyHTML=j.html().trim(),this.pages[f].body=j.text().trim(),this.rawdata&&(this.pages[f]._rawData=e);case 8:case"end":return a.stop();}},a,this)}));return function _detailtify(){return a.apply(this,arguments)}}()},{key:"_log",value:function _log(a){this.verbose&&console.log("[".concat(+Date.now(),"] ").concat(a))}}]),a}();module.exports=Blizzcle;