"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),fetch=require("node-fetch"),$=require("cheerio"),fs=require("fs"),BlizzBlogAPI=/*#__PURE__*/function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};(0,_classCallCheck2.default)(this,a),this.verbose="undefined"!=typeof b.verbose&&b.verbose,this.maxCount="undefined"==typeof b.maxCount?0:parseInt(b.maxCount),this.filename="undefined"==typeof b.filename?"blizz":b.filename,this.game="undefined"==typeof b.game?"heroes-of-the-storm":b.game.toLowerCase(),this.language="undefined"==typeof b.language?"en-us":b.language.toLowerCase()}return(0,_createClass2.default)(a,[{key:"get",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(){var b=this;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new Promise(/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(c,d){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b._getPages().then(function(c){c.forEach(function(a){var c;(c=b.pages).push.apply(c,(0,_toConsumableArray2.default)(b._parse(a.html)))})}).catch(function(a){d(a)});case 2:b.pages=0==b.maxCount?b.pages:b.pages.slice(0,b.maxCount),c(b.pages);case 4:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()));case 1:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"saveJSON",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(){var b=this;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new Promise(/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(c,d){var e;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b.get().catch(d);case 2:e=a.sent,fs.writeFile(b.filename,JSON.stringify(e),{encoding:"utf8"},function(a){a?d(a):c(!0)});case 4:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()));case 1:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"_download",value:function c(a){var b="".concat("https://news.blizzard.com","/").concat(this.language,"/blog/list?pageNum=").concat(a,"&community=").concat(this.game);return fetch(b).then(function(a){if(!a.ok)throw Error(a.statusText);return a.json()}).catch(function(a){throw Error(a)})}},{key:"_getPages",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(){var b,c,d,e,f,g;return _regenerator.default.wrap(function(a){var h=Math.ceil;for(;;)switch(a.prev=a.next){case 0:return this.pages=[],c=[],this._log("Downloading Page 1 for metadata and its content."),a.next=5,this._download(1).catch(function(a){throw a});case 5:for(d=a.sent,(b=this.pages).push.apply(b,(0,_toConsumableArray2.default)(this._parse(d.html))),this.metadata={totalCount:d.totalCount,game:"undefined"==typeof d.community?"All":d.community.slug},e=this.metadata.totalCount,this._log("Community name : ".concat(this.metadata.game)),this._log("Total article count in \"".concat(this.metadata.game,"\": ").concat(this.metadata.totalCount)),0!==this.maxCount&&(e=this.maxCount,this._log("Number of articles will be extracted: ".concat(e))),f=h((e-30)/30),this._log("Number of extra pages to be fetched: ".concat(f)),g=0;g<f;g++)// const json = await this._download(i + 2).catch(e => {
//   throw e;
// });
this._log("Fetching extra page: ".concat(g+1," / ").concat(f," ...")),c.push(this._download(g+2));return a.next=17,Promise.all(c);case 17:return a.abrupt("return",a.sent);case 18:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"_parse",value:function c(a){var b=[];return $(".ArticleListItem",a).each(function(){var a=$(this).find("h3.ArticleListItem-title").text().trim(),c="https:"+$(this).find("div.ArticleListItem-image").css("background-image").replace("url(","").replace(")","").replace(/\"/gi,""),d=$(this).find(".ArticleListItem-description").text().trim(),e=$(this).find("a.ArticleLink").attr("href"),f=$(this).find("span.ArticleListItem-footerTimestamp").text().trim(),g=parseInt($(this).find(".ArticleCommentCount-count").text().trim()),h=parseInt($(this).find("a.ArticleLink").attr("data-article-id"));b.push({title:a,thumbnail:c,description:d,link:/^https?:\/\//i.test(e)?e:"https://news.blizzard.com"+e,timestamp:f,commentCount:g?g:0,id:h})}),b}},{key:"_log",value:function b(a){this.verbose&&console.log("[".concat(+Date.now(),"] ").concat(a))}}]),a}();module.exports=BlizzBlogAPI;