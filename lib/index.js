"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),fetch=require("node-fetch"),$=require("cheerio"),fs=require("fs"),BlizzBlogAPI=/*#__PURE__*/function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};(0,_classCallCheck2.default)(this,a),this.verbose="undefined"!=typeof b.verbose&&b.verbose,this.maxCount="undefined"==typeof b.maxCount?0:b.maxCount,this.filename="undefined"==typeof b.filename?"blog.json":b.filename,this.game="undefined"==typeof b.game?"heroes-of-the-storm":b.game,this.language="undefined"==typeof b.language?"en-us":b.language}return(0,_createClass2.default)(a,[{key:"get",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(){var b=this;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new Promise(/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(c,d){var e;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b._getPages().catch(d);case 2:e=[],b.pages.forEach(function(a){a.forEach(function(a){e.push(a)})}),c(0==b.maxCount?e:e.slice(0,b.maxCount));case 5:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()));case 1:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"save",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(){var b=this;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new Promise(/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(c,d){var e;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b.get().catch(d);case 2:e=a.sent,fs.writeFile(b.filename,JSON.stringify(e),{encoding:"utf8"},function(a){a?d(a):c(!0)});case 4:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()));case 1:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"_download",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(b){var c,d;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c="https://news.blizzard.com",d="".concat(c,"/").concat(this.language,"/blog/list?pageNum=").concat(b,"&community=").concat(this.game),a.next=4,fetch(d).then(function(a){if(!a.ok)throw Error(a.statusText);return a.json()}).catch(function(a){throw Error(a)});case 4:return a.abrupt("return",a.sent);case 5:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"_getPages",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(){var b,c,d,e,f;return _regenerator.default.wrap(function(a){var g=Math.ceil;for(;;)switch(a.prev=a.next){case 0:return this.pages=[],this._log("Downloading Page 1 for metadata and its content."),a.next=4,this._download(1).catch(function(a){throw a});case 4:b=a.sent,this.pages.push(this._parse(b.html)),this.metadata={totalCount:b.totalCount,game:"undefined"==typeof b.community?"All":b.community.slug},c=this.metadata.totalCount,this._log("Community name : ".concat(this.metadata.game)),this._log("Total article count in \"".concat(this.metadata.game,"\": ").concat(this.metadata.totalCount)),0!==this.maxCount&&(c=this.maxCount,this._log("Number of articles will be extracted: ".concat(c))),d=g((c-30)/30),this._log("Number of extra pages to be fetched: ".concat(d)),e=0;case 14:if(!(e<d)){a.next=23;break}return this._log("Fetching extra page: ".concat(e+1," / ").concat(d," ...")),a.next=18,this._download(e+2).catch(function(a){throw a});case 18:f=a.sent,this.pages.push(this._parse(f.html));case 20:e++,a.next=14;break;case 23:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"_parse",value:function c(a){var b=[];return $(".ArticleListItem",a).each(function(){var a=$(this).find("h3.ArticleListItem-title").text().trim(),c="https:"+$(this).find("div.ArticleListItem-image").css("background-image").replace("url(","").replace(")","").replace(/\"/gi,""),d=$(this).find(".ArticleListItem-description").text().trim(),e=$(this).find("a.ArticleLink").attr("href"),f=$(this).find("span.ArticleListItem-footerTimestamp").text().trim(),g=parseInt($(this).find(".ArticleCommentCount-count").text().trim()),h=parseInt($(this).find("a.ArticleLink").attr("data-article-id"));b.push({title:a,thumbnail:c,description:d,link:/^https?:\/\//i.test(e)?e:"https://news.blizzard.com"+e,timestamp:f,commentCount:g?g:0,id:h})}),b}},{key:"_log",value:function b(a){this.verbose&&console.log("[".concat(+Date.now(),"] ").concat(a))}}]),a}();module.exports=BlizzBlogAPI;