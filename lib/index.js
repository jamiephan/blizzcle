"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),fetch=require("node-fetch"),$=require("cheerio"),fs=require("fs"),Blizzcle=/*#__PURE__*/function(){function a(){var b=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};(0,_classCallCheck2.default)(this,a),this.verbose="undefined"!=typeof b.verbose&&b.verbose,this.count="undefined"==typeof b.count?0:parseInt(b.count),this.detail="undefined"!=typeof b.detail&&b.detail,this.filename="undefined"==typeof b.filename?"blizz":b.filename,this.game="undefined"==typeof b.game?"heroes-of-the-storm":b.game.toLowerCase(),this.language="undefined"==typeof b.language?"en-us":b.language.toLowerCase()}return(0,_createClass2.default)(a,[{key:"get",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(){var b=this;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new Promise(/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(c,d){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b._getPages().then(function(c){c.forEach(function(a){var c;(c=b.pages).push.apply(c,(0,_toConsumableArray2.default)(b._parse(a.html)))})}).catch(function(a){d(a)});case 2:if(b.pages=0==b.count?b.pages:b.pages.slice(0,b.count),!b.detail){a.next=6;break}return a.next=6,b._detailtify().catch(d);case 6:c(b.pages);case 7:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()));case 1:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"save",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(){var b,c,d,e,f,g=this,h=arguments;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b=0<h.length&&void 0!==h[0]?h[0]:{},"undefined"!=typeof b.filename){a.next=3;break}throw new Error("filename is not defined");case 3:if(this.type="undefined"==typeof b.type?"json":b.type,["json","html"].includes(this.type.toLowerCase())){a.next=6;break}throw new Error("File type can only be json or html.");case 6:return a.next=8,this.get().catch(function(a){throw a});case 8:if(c=a.sent,"json"===this.type.toLowerCase())d=JSON.stringify(c);else{for(d="<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content=\"width=device-width, initial-scale=1, shrink-to-fit=no\"><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css integrity=sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4 crossorigin=anonymous><title>".concat(this.game," Article Viewer</title><style>th{cursor:pointer}img{width:260px;height:130px}</style><script src=https://code.jquery.com/jquery-3.3.1.slim.min.js integrity=sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js integrity=sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ crossorigin=anonymous></script><script src=https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js integrity=sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm crossorigin=anonymous></script><script src=http://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js></script><script src=https://cdn.rawgit.com/tuupola/jquery_lazyload/2.x/lazyload.min.js></script></head><body><nav class=\"navbar navbar-light bg-light justify-content-between\"><a class=navbar-brand>").concat(this.game," Article Viewer</a><ul class=navbar-nav><a class=nav-link href=https://www.reddit.com/u/jamiephan>(by /u/jamiephan)</a></ul></nav><div class=container id=blogs><div class=row><div class=\"col s12\"><h1>Blogs</h1></div></div><div class=row><div class=\"col s4\"><input id=blog-search type=text class=\"search form-control\" placeholder=Search autocomplete=off></div></div><div class=row><div class=\"col s12\"><table class=\"table table-hover\"><thead><tr><th scope=col data-sort=hash data-asc=asc onclick=sort(this)>#</th><th scope=col>Thumbnail</th><th scope=col data-sort=title data-asc=asc onclick=sort(this)>Blog Title</th><th scope=col data-sort=date data-asc=asc onclick=sort(this)>Date (UTC)</th></tr></thead><tbody class=list>"),e=0;e<c.length;e++)f=c[e],d+="<tr><th scope=row class=hash>".concat(e+1,"</th><td><img class=lazyload data-src=").concat(f.thumbnail," \n        src=https://dummyimage.com/260x130/a1a1a1/2b2b2b.gif /></td><td class=title><a href=").concat(f.link," target=\"_blank\">").concat(f.title,"</td></a><td class=dateStr>").concat(new Date(f.timestamp).getUTCFullYear(),"-").concat(("0"+new Date(f.timestamp).getMonth()).slice(-2),"-").concat(("0"+new Date(f.timestamp).getUTCDate()).slice(-2)," ").concat(("0"+new Date(f.timestamp).getUTCHours()).slice(-2),":").concat(("0"+new Date(f.timestamp).getUTCMinutes()).slice(-2),"</td><td class=date style=display:none>").concat(f.timestamp,"</td></tr>");d+="</tbody></table></div></div></div><script>lazyload();var options={valueNames:[\"hash\",\"title\",\"date\"]};var blogList=new List(\"blogs\",options);function sort(a){blogList.sort(a.dataset.sort,{order:a.dataset.asc});a.dataset.asc=(a.dataset.asc==\"asc\"?\"desc\":\"asc\")};</script></body></html>"}return a.abrupt("return",new Promise(/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(b,c){return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:fs.writeFile(g.filename,d,{encoding:"utf8"},function(a){a?c(a):b(!0)});case 1:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()));case 11:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"_download",value:function f(a,b){var c="";for(var d in b)""!=c&&(c+="&"),c+=d+"="+encodeURIComponent(b[d]);var e="".concat("https://news.blizzard.com","/").concat(this.language,"/blog/").concat(a,"?").concat(c,"&__NO_CACHE__=").concat(+new Date);return fetch(e).then(function(a){if(!a.ok)throw Error(a.statusText);return a.json()}).catch(function(a){throw Error(a)})}},{key:"_getPages",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(){var b,c,d,e,f,g;return _regenerator.default.wrap(function(a){var h=Math.ceil;for(;;)switch(a.prev=a.next){case 0:return this.pages=[],c=[],this._log("Downloading Page 1 for metadata and its content."),a.next=5,this._download("list",{pageNum:1,community:this.game}).catch(function(a){throw a});case 5:for(d=a.sent,(b=this.pages).push.apply(b,(0,_toConsumableArray2.default)(this._parse(d.html))),this.metadata={totalCount:d.totalCount,game:"undefined"==typeof d.community?"All":d.community.slug},e=this.metadata.totalCount,this._log("Community name : ".concat(this.metadata.game)),this._log("Total article count in \"".concat(this.metadata.game,"\": ").concat(this.metadata.totalCount)),0!==this.count&&(e=this.count,this._log("Number of articles will be extracted: ".concat(e))),f=h((e-30)/30),this._log("Number of extra pages to be fetched: ".concat(f)),g=0;g<f;g++)this._log("Fetching extra page: ".concat(g+1," / ").concat(f," ...")),c.push(this._download("list",{pageNum:g+2,community:this.game}));return this._log("Waiting ".concat(c.length," request to be completed...")),a.next=18,Promise.all(c);case 18:return a.abrupt("return",a.sent);case 19:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"_parse",value:function c(a){var b=[];//Blogs in feature
return $(".GalleryItem",a).each(function(){var a=$(this).find("div.TextOverflow").text().trim(),c="https:"+$(this).find("div.Card-image").css("background-image").replace("url(","").replace(")","").replace(/\"/gi,""),d=$(this).find("a.ArticleLink").attr("href"),e=$(this).find("span.ArticleListItem-footerTimestamp").text().trim(),f=0,g=parseInt($(this).find("a.ArticleLink").attr("data-article-id"));b.push({title:a,thumbnail:c,description:null,link:/^https?:\/\//i.test(d)?d:"https://news.blizzard.com"+d,timestamp:e,commentCount:0,id:g})}),$(".ArticleListItem",a).each(function(){var a=$(this).find("h3.ArticleListItem-title").text().trim(),c="https:"+$(this).find("div.ArticleListItem-image").css("background-image").replace("url(","").replace(")","").replace(/\"/gi,""),d=$(this).find(".ArticleListItem-description").text().trim(),e=$(this).find("a.ArticleLink").attr("href"),f=$(this).find("span.ArticleListItem-footerTimestamp").text().trim(),g=parseInt($(this).find(".ArticleCommentCount-count").text().trim()),h=parseInt($(this).find("a.ArticleLink").attr("data-article-id"));b.push({title:a,thumbnail:c,description:d,link:/^https?:\/\//i.test(e)?e:"https://news.blizzard.com"+e,timestamp:f,commentCount:g?g:0,id:h})}),b}},{key:"_detailtify",value:function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(){var b=this;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new Promise(/*#__PURE__*/function(){var a=(0,_asyncToGenerator2.default)(/*#__PURE__*/_regenerator.default.mark(function a(c,d){var e,f,g,h,j,k,l,m,n;return _regenerator.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:for(b._log("Downloading details to each post"),e=[],f=0;f<b.pages.length;f++)g=b.pages[f],b._log("Fetching Details of the post "+g.id+" ("+g.title+")"),e.push(b._download("detail",{blogId:g.id,full:!1}));return b._log("Waiting ".concat(e.length," request to be completed...")),a.next=6,Promise.all(e).catch(d);case 6:for(h=a.sent,j=0;j<h.length;j++)k=h[j],l=$("article",k.html).find(".ArticleDetail-bylineDate").attr("title"),m=$("article",k.html).find(".ArticleDetail-content"),n=+new Date(l),b.pages[j].timestamp=n,b.pages[j].bodyHTML=m.html().trim(),b.pages[j].body=m.text().trim();c(!0);case 9:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()));case 1:case"end":return a.stop();}},a,this)}));return function b(){return a.apply(this,arguments)}}()},{key:"_log",value:function b(a){this.verbose&&console.log("[".concat(+Date.now(),"] ").concat(a))}}]),a}();module.exports=Blizzcle;